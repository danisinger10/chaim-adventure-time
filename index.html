<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chaim’s Adventure</title>

    <!-- TailwindCSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown parser (optional but nice) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      body { background:#0f172a; color:#f1f5f9; }
      #scene { background-size:cover; background-position:center; transition:background-image 0.6s ease-out; }
    </style>
  </head>
  <body class="min-h-screen flex flex-col items-center p-4 select-none">
    <h1 class="text-3xl font-bold mb-4">Chaim’s Adventure</h1>
    <div id="scene" class="w-full max-w-3xl p-6 rounded-xl bg-slate-800 shadow mb-6 whitespace-pre-wrap leading-relaxed"></div>
    <div id="choices" class="w-full max-w-3xl flex flex-col gap-3"></div>

    <script type="module">
      // --- Genesis Engine: generates world history on first load ---
      const GEMINI_KEY = 'YOUR_GEMINI_KEY';
      async function runGenesisEngine() {
        const saved = localStorage.getItem('chaimWorldHistory');
        if (saved) return JSON.parse(saved);

        if (GEMINI_KEY === 'YOUR_GEMINI_KEY') {
          const placeholder = { myth: 'In the beginning...' };
          localStorage.setItem('chaimWorldHistory', JSON.stringify(placeholder));
          return placeholder;
        }

        const prompt = `Generate a creation myth, two fallen precursor empires with conflicting ideologies, a cataclysmic event that reshaped the world, and three legendary artifacts tied to these events. Respond in JSON.`;
        try {
          const res = await fetch(
            'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GEMINI_KEY,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ role: 'user', parts: [{ text: prompt }] }]
              })
            }
          );
          const data = await res.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
          const history = JSON.parse(text);
          localStorage.setItem('chaimWorldHistory', JSON.stringify(history));
          return history;
        } catch (err) {
          console.error('Genesis Engine failed', err);
          return null;
        }
      }

      const playerState = { worldHistory: null };
      // ========================= Story Engine (inlined) =========================
      /* Branching Story Engine v2 – self‑contained */
      class StoryEngine {
        constructor({ data, onScene, rng=Math.random }) {
          this.data = data;
          this.onScene = onScene;
          this.rng = rng;
          this.state = { current:null, flags:{}, history:[] };
        }
        start(nodeId="start", savedFlags=null) {
          if (savedFlags) this.state.flags = { ...savedFlags };
          this.#enter(nodeId);
        }
        choose(choiceIndex) {
          const node = this.data[this.state.current];
          const choices = this.#visible(node);
          const choice = choices[choiceIndex];
          if (!choice) return;
          if (choice.setFlags) Object.entries(choice.setFlags).forEach(([k,v])=>{this.state.flags[k]=v;});
          if (choice.unsetFlags) choice.unsetFlags.forEach(k=>delete this.state.flags[k]);
          this.#enter(choice.target);
        }
        save() { return JSON.stringify({current:this.state.current,flags:this.state.flags,history:this.state.history}); }
        load(str) { const obj=JSON.parse(str); this.state.flags=obj.flags||{}; this.state.history=obj.history||[]; this.#enter(obj.current); }
        // ----- privates -----
        #enter(id){
          const n=this.data[id]; if(!n) throw Error(`Node ${id} missing`);
          this.state.current=id; this.state.history.push(id);
          if(n.flags) Object.entries(n.flags).forEach(([k,v])=>{ v===null?delete this.state.flags[k]:this.state.flags[k]=v; });
          this.onScene({...n,visibleChoices:this.#visible(n)});
          if(this._timer) clearTimeout(this._timer);
          if(n.timeout && n.next){ this._timer=setTimeout(()=>this.#enter(n.next), n.timeout); }
          if(typeof n.onEnter==="function") n.onEnter(this);
        }
        #visible(node){
          if(!node.choices) return [];
          let pool=node.choices.filter(c=>{
            const reqOk=!c.require||c.require.every(f=>this.state.flags[f]);
            const exOk=!c.exclude||c.exclude.every(f=>!this.state.flags[f]);
            return reqOk&&exOk;
          });
          if(pool.some(c=>c.weight>1)){ const tot=pool.reduce((s,c)=>s+(c.weight||1),0); let roll=this.rng()*tot; for(const c of pool){ roll-=c.weight||1; if(roll<=0) return [c]; } }
          return pool;
        }
      }
      // ========================= Demo Story =========================
      const demoStory={
        start:{
          text:"Sirens cut through the night as **you** vault a toppled dumpster.\n\nTwo routes flash before you:",
          choices:[
            {text:"Scale the chain‑link fence",target:"fence",setFlags:{athletic:true}},
            {text:"Kick open the service door",target:"door"}
          ]
        },
        fence:{
          text:"Your fingers sting as you haul over the rattling fence. An agent swings a stun gun up at you!",
          choices:[
            {text:"Leap to the alley",target:"alley",weight:2,require:["athletic"]},
            {text:"Freeze and plead innocence",target:"caught"}
          ]
        },
        door:{
          text:"The rusty door screeches into a boiler room thick with steam.",
          flags:{stealth:true},
          choices:[
            {text:"Sneak between the boilers",target:"boiler",require:["stealth"]},
            {text:"Rip a pipe loose as weapon",target:"armed",setFlags:{armed:true},unsetFlags:["stealth"]}
          ]
        },
        alley:{ text:"You roll onto wet asphalt and sprint into darkness. **You escaped—for now.**", choices:[] },
        caught:{ text:"Blue arcs of electricity kiss your vision goodbye. **BUSTED.**", choices:[] },
        boiler:{ text:"You glide past gauges. A secret hatch glows red ahead…", choices:[] },
        armed:{ text:"Pipe in hand, you feel invincible—until footsteps echo behind you…", choices:[] }
      };
      // ========================= Renderer =========================
      const sceneEl=document.getElementById("scene");
      const choicesEl=document.getElementById("choices");
      const md=(s)=>window.marked?marked.parse(s):s.replace(/\n/g,"<br>");
      const engine=new StoryEngine({
        data:demoStory,
        onScene:({text,img,visibleChoices})=>{
          sceneEl.innerHTML=md(text);
          sceneEl.style.backgroundImage=img?`url(${img})`:"none";
          choicesEl.innerHTML="";
          if(!visibleChoices.length){
            const end=document.createElement("p"); end.textContent="THE END — refresh to replay"; choicesEl.appendChild(end); return; }
          visibleChoices.forEach((c,i)=>{
            const b=document.createElement("button");
            b.className="px-4 py-2 rounded bg-purple-700 hover:bg-purple-600 active:scale-95 transition text-white";
            b.textContent=c.text;
            b.onclick=()=>engine.choose(i);
            choicesEl.appendChild(b);
          });
          localStorage.setItem('chaimAdventureSave',engine.save());
        }
      });
      (async () => {
        playerState.worldHistory = await runGenesisEngine();
        try {
          const saved = localStorage.getItem('chaimAdventureSave');
          saved ? engine.load(saved) : engine.start();
        } catch (e) {
          console.error(e);
          engine.start();
        }
      })();
    </script>
  </body>
</html>
