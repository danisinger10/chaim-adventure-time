<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chaim's Adventure</title>
    <!-- Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Premium fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      /* Use premium fonts for headings and body */
      h1, h2, h3 {
        font-family: 'Playfair Display', serif;
      }
      body, input, button, p, span {
        font-family: 'Inter', sans-serif;
      }
      /* Custom styles for nicer typography */
      .story-paragraph {
        @apply mb-4 text-lg md:text-xl leading-relaxed;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-gray-800 text-gray-100 flex flex-col">
    <div id="app" class="flex-grow flex items-center justify-center p-4"></div>
    <footer class="text-center text-gray-500 text-sm py-4">
      Powered by Google Gemini &amp; Imagen. Each adventure is unique.
    </footer>

    <script type="module">
      import { narrate, toggleNarrator, setVoice, VOICE_OPTIONS } from './narrator.js';
      // === Narrator toggle button ===
const narrBtn = document.createElement('button');
narrBtn.textContent = 'ðŸŽ™ Narrator';
narrBtn.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg bg-yellow-700 text-gray-900 font-bold shadow-lg';
document.body.appendChild(narrBtn);

const voiceSelect = document.createElement('select');
voiceSelect.className = 'fixed top-4 left-4 px-2 py-1 rounded-lg bg-gray-800 text-yellow-300';
Object.entries(VOICE_OPTIONS).forEach(([name, id]) => {
  const opt = document.createElement('option');
  opt.value = id; opt.textContent = name; voiceSelect.appendChild(opt);
});
voiceSelect.addEventListener('change', (e) => {
  setVoice(e.target.value);
});
document.body.appendChild(voiceSelect);

const invBtn = document.createElement('button');
invBtn.textContent = 'ðŸ“¦ Inventory';
invBtn.className = 'fixed bottom-4 left-4 px-3 py-2 rounded-lg bg-gray-800 text-yellow-300';
document.body.appendChild(invBtn);

invBtn.addEventListener('click', renderInventory);

narrBtn.addEventListener('click', () => {
  const enabled = narrBtn.classList.toggle('bg-yellow-500');
  toggleNarrator(enabled);
});
// === End toggle ===

      /*
       * Chaim's Adventure v2 (Mobile Fix + UI upgrade)
       *
       * This version automatically uses a provided API key and presents a
       * redesigned home screen with suggested adventures. The mobile upload bug
       * is handled via a fallback when ReadableStream uploads are unsupported.
       */

      import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.11.0?bundle';

      // Automatically use the user-provided API key. This removes the need
      // for manual API key entry.
      const apiKey = 'AIzaSyBOMarZfaw9O5v5ncQjocSRQ-G2I55Onb8';
      let ai = new GoogleGenAI({ apiKey });

      // Suggested adventure themes. The first two suggestions are specific
      // requests from the user; the others are generic examples. Feel free to
      // customize these to your liking.
      const suggestions = [
        "Chaim's quest to attain his ADHD meds",
        "Chaim's ambitious venture to launch a new location of his friend's personal training company",
        "Chaim exploring a mysterious temple in the Amazon",
        "Chaim solving a cyberâ€‘crime in a futuristic city",
        "Chaim on a space mission to rescue his crew"
      ];

      const communityThemes = JSON.parse(localStorage.getItem('communityThemes') || '[]');

      // UI root
      const app = document.getElementById('app');

      let gameState = { theme: null, history: [], inventory: [], stats: {}, lastImage: null };

      function loadGameState() {
        try {
          const data = JSON.parse(localStorage.getItem('chaimAdventureSave'));
          if (data) gameState = data;
        } catch {}
      }

      function saveGameState() {
        localStorage.setItem('chaimAdventureSave', JSON.stringify(gameState));
      }

      // History state for context
      let history = [];

      // Detect if ReadableStream uploads are supported
      function supportsReadableStreamUploads() {
        try {
          // eslint-disable-next-line no-new
          new ReadableStream();
          return true;
        } catch (e) {
          return false;
        }
      }

      // Prompt instruction builder
      function getPromptInstruction(userRequest) {
        const inv = gameState.inventory.length ? `Chaim currently carries: ${gameState.inventory.join(', ')}.` : '';
        const stats = Object.keys(gameState.stats).length ? ` Stats: ${JSON.stringify(gameState.stats)}.` : '';
        return `You are an expert text-based adventure game master. Your goal is to create a dynamic, engaging, and imaginative story for a player named Chaim. ${inv}${stats}\n\n` +
          `- The player character's name is ALWAYS Chaim. Refer to the player as Chaim in the story.\n` +
          `- Your entire response MUST be a single, valid JSON object and nothing else. Do not wrap it in markdown.\n\n` +
          `The JSON object must have this exact structure:\n` +
          `{\n` +
          `  "description": "A detailed, immersive description of the current scene, formatted as 2-3 short paragraphs separated by a newline character ('\\n'). Write in the second person about 'Chaim' (e.g., 'You see...'). Wrap key nouns (items, characters, locations) in markdown bold (e.g., **the ancient sword**) to highlight them.",\n` +
          `  "imagePrompt": "A concise, descriptive prompt for an image generator that includes Chaim. Focus on key visual elements: subject (Chaim), setting, mood, and style (e.g., 'cinematic, dark fantasy, Chaim stands before a glowing portal in a crumbling ruin').",\n` +
          `  "choices": [\n` +
          `    { "text": "A short, actionable phrase for the first choice." },\n` +
          `    { "text": "A short, actionable phrase for the second choice." },\n` +
          `    { "text": "A short, actionable phrase for a third choice." }\n` +
          `  ]\n` +
          `}\n\n` +
          `Now, fulfill this request for Chaim:\n${userRequest}`;
      }

      function parseGeminiResponse(responseText) {
        if (!responseText) {
          throw new Error('Gemini returned an empty response.');
        }
        const cleanJson = responseText.replace(/^```json/, '').replace(/```$/, '').trim();
        let parsed;
        try {
          parsed = JSON.parse(cleanJson);
        } catch (err) {
          console.error('Failed to parse Gemini response as JSON:', responseText);
          throw new Error('The story took an unexpected turn. The format of the response was unreadable.');
        }
        if (!parsed.description || !parsed.imagePrompt || !Array.isArray(parsed.choices)) {
          throw new Error('Invalid JSON structure from Gemini.');
        }
        return parsed;
      }

      async function generateContentSafe(model, prompt) {
        if (!supportsReadableStreamUploads()) {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
          const body = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const errText = await res.text();
            throw new Error(`Gemini API request failed: ${res.status} ${res.statusText}\n${errText}`);
          }
          const data = await res.json();
          const candidate = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text;
          if (!candidate) {
            throw new Error('Gemini API returned no content');
          }
          return { text: candidate };
        }
        return await ai.models.generateContent({ model, contents: prompt });
      }

      async function generateImage(prompt) {
        try {
          const response = await ai.models.generateImages({
            model: 'imagen-3.0-generate-002',
            prompt: `${prompt}, cinematic lighting, fantasy art, epic, highly detailed`,
            config: {
              numberOfImages: 1,
              outputMimeType: 'image/jpeg',
              aspectRatio: '16:9',
            },
          });
          if (!response.generatedImages || response.generatedImages.length === 0) {
            throw new Error('Image generation failed, no images returned.');
          }
          return response.generatedImages[0].image.imageBytes;
        } catch (error) {
          console.error('Error generating image:', error);
          throw new Error('Failed to generate scene image.');
        }
      }

      // Render home screen
      function renderHome() {
        app.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'max-w-3xl w-full text-center flex flex-col items-center space-y-8';
        container.innerHTML = `
          <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 via-yellow-600 to-yellow-700 drop-shadow-xl">Chaim's Adventure</h1>
          <p class="text-gray-300 text-lg md:text-xl max-w-2xl mx-auto">Embark on an AIâ€‘driven story tailored to Chaimâ€™s quests. Choose a suggested adventure or craft your own theme.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl">
            ${[...suggestions, ...communityThemes].map(theme => `
              <button data-theme="${encodeURIComponent(theme)}" class="block px-4 py-4 rounded-lg bg-gradient-to-r from-yellow-600 to-yellow-800 hover:from-yellow-500 hover:to-yellow-700 text-gray-900 font-semibold shadow-md transition-colors focus:outline-none">
                ${theme}
              </button>
            `).join('')}
          </div>
          <div class="w-full max-w-2xl space-y-4">
            <input id="custom-theme" type="text" placeholder="Or enter your own adventure theme" class="w-full p-3 rounded-lg border border-yellow-600 bg-gray-900 text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
            <button id="start-custom" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-yellow-500 to-yellow-700 hover:from-yellow-400 hover:to-yellow-600 text-gray-900 font-semibold shadow-md transition-colors focus:outline-none">Start Custom Adventure</button>
            <button id="save-theme" class="w-full px-4 py-2 bg-yellow-700 text-gray-900 rounded-lg">Save Theme to Community</button>
          </div>
        `;
        app.appendChild(container);
        // Attach event listeners for suggested themes
        container.querySelectorAll('button[data-theme]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const theme = decodeURIComponent(e.currentTarget.getAttribute('data-theme'));
            history = [];
            await startGame(theme);
          });
        });
        // Custom theme button
        container.querySelector('#start-custom').addEventListener('click', async () => {
          const custom = container.querySelector('#custom-theme').value.trim();
          if (!custom) {
            alert('Please enter a theme or select a suggestion.');
            return;
          }
          history = [];
          await startGame(custom);
        });
        container.querySelector('#save-theme').addEventListener('click', () => {
          const custom = container.querySelector('#custom-theme').value.trim();
          if (custom && !communityThemes.includes(custom)) {
            communityThemes.push(custom);
            localStorage.setItem('communityThemes', JSON.stringify(communityThemes));
            alert('Saved to community!');
            renderHome();
          }
        });
      }

      function renderResume() {
        app.innerHTML = '';
        const box = document.createElement('div');
        box.className = 'space-y-4 text-center';
        box.innerHTML = `
          <h2 class="text-3xl font-bold">Resume your adventure?</h2>
          <div class="flex justify-center gap-4">
            <button id="resume" class="px-4 py-2 bg-yellow-600 text-gray-900 rounded-lg">Resume</button>
            <button id="new" class="px-4 py-2 bg-gray-700 text-gray-100 rounded-lg">New Game</button>
          </div>
        `;
        app.appendChild(box);
        box.querySelector('#resume').addEventListener('click', async () => {
          history = gameState.history;
          if (history.length) {
            try {
              const lastResp = parseGeminiResponse(history.at(-1).parts[0].text);
              renderScene({ ...lastResp, imageBase64: gameState.lastImage });
            } catch {
              renderHome();
            }
          } else if (gameState.theme) {
            startGame(gameState.theme);
          } else {
            renderHome();
          }
        });
        box.querySelector('#new').addEventListener('click', () => {
          gameState = { theme: null, history: [], inventory: [], stats: {}, lastImage: null };
          saveGameState();
          renderHome();
        });
      }

      function renderInventory() {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/70 flex items-center justify-center';
        overlay.innerHTML = `
          <div class="bg-gray-800 p-6 rounded-lg space-y-4 max-w-sm w-full">
            <h3 class="text-xl font-bold text-yellow-400">Inventory</h3>
            <ul class="space-y-2 text-gray-100">
              ${gameState.inventory.map(i => `<li>${i}</li>`).join('') || '<li>Empty</li>'}
            </ul>
            <input id="new-item" class="w-full p-2 rounded bg-gray-700" placeholder="Add item" />
            <div class="flex justify-end gap-2">
              <button id="add-item" class="px-3 py-1 bg-yellow-600 text-gray-900 rounded">Add</button>
              <button id="close-inv" class="px-3 py-1 bg-gray-600 text-gray-100 rounded">Close</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('#close-inv').addEventListener('click', () => overlay.remove());
        overlay.querySelector('#add-item').addEventListener('click', () => {
          const val = overlay.querySelector('#new-item').value.trim();
          if (val) {
            gameState.inventory.push(val);
            saveGameState();
            overlay.remove();
            renderInventory();
          }
        });
      }

      // Render loading screen
      function renderLoading(message = 'Generating your adventure...') {
        app.innerHTML = '';
        const loading = document.createElement('div');
        loading.className = 'text-center flex flex-col items-center space-y-4';
        loading.innerHTML = `
          <svg class="animate-spin h-10 w-10 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          <p class="text-lg text-yellow-300 animate-pulse">${message}</p>
        `;
        app.appendChild(loading);
      }

      // Render error screen
      function renderError(errorMessage) {
        app.innerHTML = '';
        const err = document.createElement('div');
        err.className = 'max-w-md mx-auto text-center bg-gray-800/80 p-6 rounded-lg border border-yellow-600 space-y-4';
        err.innerHTML = `
          <h2 class="text-2xl font-bold text-yellow-400">An Error Occurred</h2>
          <p class="text-yellow-300">${errorMessage}</p>
          <button id="restart" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-700 hover:from-yellow-400 hover:to-yellow-600 text-gray-900 font-semibold rounded-lg transition-colors">Back to Home</button>
        `;
        app.appendChild(err);
        err.querySelector('#restart').addEventListener('click', () => {
          renderHome();
        });
      }

// Render story scene
function renderScene(scene) {
  app.innerHTML = '';
  const wrapper = document.createElement('div');
  wrapper.className =
    'w-full max-w-3xl mx-auto bg-gray-800/70 p-6 md:p-8 rounded-lg border border-yellow-600 shadow-2xl space-y-6';

  const descriptionHtml = scene.description
    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-yellow-300">$1</strong>')
    .replace(/\n/g, '<br/>');

  wrapper.innerHTML = `
    <div class="text-left text-gray-100 space-y-4">
      ${descriptionHtml}
    </div>
    <div class="flex justify-center">
      ${
        scene.imageBase64
          ? `<img src="data:image/jpeg;base64,${scene.imageBase64}" alt="Scene image"
              class="rounded-lg shadow-lg max-h-72 object-cover" />`
          : ''
      }
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      ${scene.choices
        .map(
          (c, idx) => `<button data-idx="${idx}"
            class="px-4 py-3 bg-gradient-to-r from-yellow-600 to-yellow-800
                   hover:from-yellow-500 hover:to-yellow-700 text-gray-900
                   font-semibold rounded-lg shadow-md transition-colors">
            ${c.text}
          </button>`
        )
        .join('')}
    </div>
    <div class="flex justify-center">
      <button id="speak-choice" class="mt-4 px-4 py-2 bg-yellow-600 text-gray-900 rounded-lg">ðŸŽ¤ Speak Choice</button>
      <button id="share" class="mt-4 ml-4 px-4 py-2 bg-yellow-700 text-gray-900 rounded-lg">Share</button>
    </div>
  `;

  /* ---------- send clean text to ElevenLabs ---------- */
  const plainText = scene.description
    .replace(/<br\s*\/?>/gi, ' ')
    .replace(/<[^>]+>/g, ''); // strip ALL html tags
  narrate(plainText);
  /* --------------------------------------------------- */

  app.appendChild(wrapper);
  gameState.history = history;
  gameState.lastImage = scene.imageBase64;
  saveGameState();

  wrapper.querySelectorAll('button[data-idx]').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const index  = parseInt(e.currentTarget.getAttribute('data-idx'), 10);
      const choice = scene.choices[index].text;
      await handleChoice(choice);
    });
  });

  const speakBtn = wrapper.querySelector('#speak-choice');
  const shareBtn = wrapper.querySelector('#share');
  if (window.SpeechRecognition || window.webkitSpeechRecognition) {
    speakBtn.addEventListener('click', () => {
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = 'en-US';
      rec.start();
      rec.onresult = async (evt) => {
        const said = evt.results[0][0].transcript.toLowerCase();
        const idx = scene.choices.findIndex(c => said.includes(c.text.toLowerCase()) || said.includes(String(scene.choices.indexOf(c)+1)));
        if (idx >= 0) {
          await handleChoice(scene.choices[idx].text);
        } else {
          alert('Could not match your choice.');
        }
      };
    });
  } else {
    speakBtn.disabled = true;
  }
  shareBtn.addEventListener('click', () => {
    const url = `${location.origin}${location.pathname}?theme=${encodeURIComponent(gameState.theme)}`;
    navigator.clipboard.writeText(url).then(() => alert('Link copied to clipboard!'));
  });
}


      // Start a new adventure
      async function startGame(theme) {
        try {
          renderLoading();
          const userMessage = `Start a new adventure for Chaim with the theme: "${theme}"`;
          const fullPrompt = getPromptInstruction(userMessage);
          const response = await generateContentSafe('gemini-2.5-flash', fullPrompt);
          const geminiResponse = parseGeminiResponse(response.text);
          const imageBase64 = await generateImage(geminiResponse.imagePrompt);
          history = [
            { role: 'user', parts: [{ text: userMessage }] },
            { role: 'model', parts: [{ text: response.text }] },
          ];
          gameState.theme = theme;
          gameState.history = history;
          gameState.lastImage = imageBase64;
          saveGameState();
          const scene = { ...geminiResponse, imageBase64 };
          renderScene(scene);
        } catch (err) {
          console.error(err);
          renderError(err instanceof Error ? err.message : String(err));
        }
      }

      // Handle player's choice
      async function handleChoice(choice) {
        try {
          renderLoading('Generating the next scene...');
          let storyContext = '';
          if (history.length > 0) {
            const lastModelTurn = history[history.length - 1];
            if (lastModelTurn && lastModelTurn.role === 'model') {
              try {
                const lastResponse = parseGeminiResponse(lastModelTurn.parts[0].text);
                storyContext = `The story so far: ${lastResponse.description}\n\n`;
              } catch (e) {
                console.warn('Could not parse last model turn for context.', e);
              }
            }
          }
          const userRequest = `${storyContext}Chaim's next action is: "${choice}". What happens now?`;
          const fullPrompt = getPromptInstruction(userRequest);
          const response = await generateContentSafe('gemini-2.5-flash', fullPrompt);
          const geminiResponse = parseGeminiResponse(response.text);
          const imageBase64 = await generateImage(geminiResponse.imagePrompt);
          history = [
            ...history,
            { role: 'user', parts: [{ text: `Chaim chose: "${choice}"` }] },
            { role: 'model', parts: [{ text: response.text }] },
          ];
          gameState.history = history;
          gameState.lastImage = imageBase64;
          saveGameState();
          const scene = { ...geminiResponse, imageBase64 };
          renderScene(scene);
        } catch (err) {
          console.error(err);
          renderError(err instanceof Error ? err.message : String(err));
        }
      }

      // Initialize
      loadGameState();
      if (gameState.history.length) {
        renderResume();
      } else {
        const params = new URLSearchParams(location.search);
        const themeParam = params.get('theme');
        if (themeParam) {
          startGame(themeParam);
        } else {
          renderHome();
        }
      }
    </script>
  </body>
</html>
