<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chaimâ€™s Adventure</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Googleâ€¯Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

    <style>
      h1,h2,h3{font-family:'Playfair Display',serif;}
      body,input,button,p,span{font-family:'Inter',sans-serif;}
      .story-paragraph{@apply mb-4 text-lg md:text-xl leading-relaxed;}
    </style>
  </head>

  <body class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-gray-800 text-gray-100 flex flex-col">

    <!-- React / vanilla root -->
    <div id="app" class="flex-grow flex items-center justify-center p-4"></div>

    <footer class="text-center text-gray-500 text-sm py-4">
      Powered by GoogleÂ GeminiÂ &Â Imagen. Each adventure is unique.
    </footer>

    <!-- persistent audio element (required for mobile unlock) -->
    <audio id="narrator-audio-element" preload="auto"></audio>

    <script type="module">
      import { narrate, toggleNarrator } from './narrator.js';
      import { GoogleGenAI }            from 'https://esm.sh/@google/genai@1.11.0?bundle';

      /* ---------- narrator controls ---------- */
      const narrBtn = document.createElement('button');
      narrBtn.textContent = 'ðŸŽ™Â Narrator';
      narrBtn.className =
        'fixed top-4 right-4 px-4 py-2 rounded-lg bg-yellow-700 text-gray-900 font-bold shadow-lg transition';
      document.body.appendChild(narrBtn);

      narrBtn.addEventListener('click', () => {
        const enabled = narrBtn.classList.toggle('bg-yellow-500');
        toggleNarrator(enabled);
      });

      /* optional speakâ€‘test button (remove in prod) */
      const speakBtn = document.createElement('button');
      speakBtn.textContent = 'ðŸ”ŠÂ SpeakÂ test';
      speakBtn.className =
        'fixed top-4 right-36 px-4 py-2 rounded-lg bg-yellow-700 text-gray-900 font-bold shadow-lg transition';
      document.body.appendChild(speakBtn);
      speakBtn.addEventListener('click', () =>
        narrate('You turn the corner and see a dragonâ€¦')
      );
      /* --------------------------------------- */

      /* -------------- Gemini setup ------------ */
      const apiKey = "AIzaSyBOMarZfaw9O5v5ncQjocSRQ-G2I55Onb8";
      let   ai;
      function getAI() {
        if (!ai) {
          if (!apiKey) throw new Error('Gemini API key missing.');
          ai = new GoogleGenAI({ apiKey });
        }
        return ai;
      }

      const suggestions = [
        "Chaim races to recover his ADHD meds before they fall into the wrong hands",
        "Chaim's bold push to open a new location of his friend's training studio despite fierce competition",
        "Chaim exploring a mysterious temple hidden deep in the Amazon",
        "Chaim untangling a highâ€‘stakes cyberâ€‘crime in a futuristic city",
        "Chaim on a daring space mission to rescue his stranded crew"
      ];

      const app     = document.getElementById('app');
      let   history = [];

      /* ------------ helpers & UI ------------- */
      function supportsReadableStreamUploads() {
        try { new ReadableStream(); return true; } catch { return false; }
      }

      function getPromptInstruction(request) {
        return (
          `You are an expert text-based adventure game master. Your goal is to craft a gripping, grounded adventure that keeps Chaim on the edge of his seat.\n\n` +
          `- The player character's name is ALWAYS Chaim. Refer to the player as Chaim in the story.\n` +
          `- Keep the narrative thrilling yet plausible, with real stakes and suspense.\n` +
          `- Your entire response MUST be a single, valid JSON object and nothing else. Do not wrap it in markdown.\n\n` +
          `The JSON object must have this exact structure:\n` +
          `{\n` +
          `  "description": "Scene text â€¦",\n` +
          `  "imagePrompt": "Prompt for image generator â€¦",\n` +
          `  "choices": [ { "text": "choice" }, { â€¦ }, { â€¦ } ]\n` +
          `}\n\n` +
          `Now, fulfill this request for Chaim:\n${request}`
        );
      }

      function parseGeminiResponse(txt) {
        const clean = txt.replace(/^```json/, '').replace(/```$/, '').trim();
        const obj   = JSON.parse(clean);
        if (!obj.description || !obj.imagePrompt || !Array.isArray(obj.choices))
          throw new Error('Gemini JSON malformed.');
        return obj;
      }

      async function generateContentSafe(model, prompt) {
        if (!supportsReadableStreamUploads()) {
          const url  = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
          const body = { contents: [{ role:'user', parts:[{ text: prompt }] }] };
          const res  = await fetch(url, {
            method : 'POST',
            headers: { 'Content-Type':'application/json' },
            body   : JSON.stringify(body)
          });
          const data = await res.json();
          return { text: data.candidates?.[0]?.content?.parts?.[0]?.text ?? '' };
        }
        return await getAI().models.generateContent({ model, contents: prompt });
      }

      async function generateImage(prompt) {
        const resp = await getAI().models.generateImages({
          model : 'imagen-3.0-generate-002',
          prompt: `${prompt}, cinematic lighting, highly detailed`,
          config: { numberOfImages:1, outputMimeType:'image/jpeg', aspectRatio:'16:9' }
        });
        return resp.generatedImages?.[0]?.image.imageBytes ?? null;
      }

      /* -------------- UI screens -------------- */
      function renderLoading(msg='Generating your adventureâ€¦') {
        app.innerHTML =
          `<div class="text-center space-y-4">
             <svg class="animate-spin h-10 w-10 text-yellow-400" viewBox="0 0 24 24" fill="none">
               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
             </svg>
             <p class="text-lg text-yellow-300 animate-pulse">${msg}</p>
           </div>`;
      }

      function renderError(msg) {
        app.innerHTML =
          `<div class="max-w-md mx-auto text-center bg-gray-800/80 p-6 rounded-lg border border-yellow-600 space-y-4">
             <h2 class="text-2xl font-bold text-yellow-400">Error</h2>
             <p class="text-yellow-300">${msg}</p>
             <button id="restart"
               class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-700 text-gray-900 font-semibold rounded-lg">
               BackÂ toÂ Home</button>
           </div>`;
        document.getElementById('restart').onclick = renderHome;
      }

      function renderHome() {
        app.innerHTML =
          `<div class="max-w-3xl mx-auto text-center space-y-8">
             <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 via-yellow-600 to-yellow-700 drop-shadow-xl">
               Chaim's Adventure
             </h1>
             <p class="text-gray-300 text-lg md:text-xl max-w-2xl mx-auto">
               Embark on an AIâ€‘driven story tailored to Chaimâ€™s quests.
             </p>
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto">
               ${suggestions.map(t => `<button data-theme="${encodeURIComponent(t)}"
                   class="px-4 py-4 rounded-lg bg-gradient-to-r from-yellow-600 to-yellow-800 text-gray-900 font-semibold shadow-md">
                   ${t}</button>`).join('')}
             </div>
             <div class="max-w-2xl mx-auto space-y-4">
               <input id="custom-theme" type="text"
                 placeholder="Or enter your own adventure theme"
                 class="w-full p-3 rounded-lg border border-yellow-600 bg-gray-900 text-gray-100" />
               <button id="start-custom"
                 class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-yellow-500 to-yellow-700 text-gray-900 font-semibold">
                 Start Custom Adventure</button>
             </div>
           </div>`;

        document.querySelectorAll('button[data-theme]').forEach(b =>
          b.onclick = () => startGame(decodeURIComponent(b.dataset.theme))
        );
        document.getElementById('start-custom').onclick = () => {
          const custom = document.getElementById('custom-theme').value.trim();
          if (!custom) return alert('Enter a theme or pick one.');
          startGame(custom);
        };
      }

      function renderScene(scene) {
        app.innerHTML =
          `<div class="w-full max-w-3xl mx-auto bg-gray-800/70 p-6 md:p-8 rounded-lg border border-yellow-600 shadow-2xl space-y-6">
             <div class="space-y-4 text-left text-gray-100">
               ${scene.description
                 .replace(/\*\*(.*?)\*\*/g,'<strong class=\"text-yellow-300\">$1</strong>')
                 .replace(/\\n/g,'<br/>')}
             </div>
             ${scene.imageBase64 ? `
               <div class="flex justify-center">
                 <img
                   class="rounded-lg shadow-lg max-h-72 object-cover"
                   src="data:image/jpeg;base64,${scene.imageBase64}"
                   alt=\"Scene image\" />
               </div>` : ''}
             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
               ${scene.choices.map((c,i)=>`
                 <button data-idx=\"${i}\"
                   class=\"px-4 py-3 bg-gradient-to-r from-yellow-600 to-yellow-800 hover:from-yellow-500 hover:to-yellow-700 text-gray-900 font-semibold rounded-lg shadow-md\">
                   ${c.text}
                 </button>`).join('')}
             </div>
           </div>`;

        // speak description (plain text, no HTML)
        narrate(scene.description.replace(/<[^>]+>/g,' ').replace(/\\s+/g,' '));

        document.querySelectorAll('button[data-idx]').forEach(btn =>
          btn.onclick = () => handleChoice(scene.choices[+btn.dataset.idx].text)
        );
      }

      /* -------------- game flow --------------- */
      async function startGame(theme) {
        try {
          renderLoading();
          const prompt = getPromptInstruction(`Start a new adventure for Chaim with the theme: \"${theme}\"`);
          const resp   = await generateContentSafe('gemini-2.5-flash', prompt);
          const parsed = parseGeminiResponse(resp.text);
          const imgB64 = await generateImage(parsed.imagePrompt);

          history = [
            { role:'user' , parts:[{ text:`Start theme: ${theme}` }] },
            { role:'model', parts:[{ text:resp.text              }] }
          ];
          renderScene({ ...parsed, imageBase64: imgB64 });
        } catch (err) {
          renderError(err.message ?? String(err));
        }
      }

      async function handleChoice(choice) {
        try {
          renderLoading('Generating the next sceneâ€¦');
          const last = history.at(-1)?.parts?.[0]?.text;
          const ctxt = last ? `The story so far: ${parseGeminiResponse(last).description}\\n\\n` : '';
          const prompt = getPromptInstruction(`${ctxt}Chaim's next action is: \"${choice}\". What happens now?`);
          const resp   = await generateContentSafe('gemini-2.5-flash', prompt);
          const parsed = parseGeminiResponse(resp.text);
          const imgB64 = await generateImage(parsed.imagePrompt);

          history.push(
            { role:'user' , parts:[{ text:`Chaim chose: ${choice}` }] },
            { role:'model', parts:[{ text:resp.text                }] }
          );
          renderScene({ ...parsed, imageBase64: imgB64 });
        } catch (err) { renderError(err.message ?? String(err)); }
      }

      /* -------------- boot --------------- */
      renderHome();
    </script>
  </body>
</html>
