<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chaim’s Adventure</title>

    <!-- TailwindCSS CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown parser (must load BEFORE our module so window.marked exists) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      /* Parallax-style background for the scene container */
      #scene {
        background-size: cover;
        background-position: center;
        transition: background-image 0.6s ease-out;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center p-4">
    <h1 class="text-3xl font-bold mb-4">Chaim’s Adventure</h1>

    <!-- Scene container -->
    <div id="scene" class="w-full max-w-3xl p-6 rounded-xl bg-gray-800 shadow-lg mb-6 whitespace-pre-wrap leading-relaxed"></div>

    <!-- Choices container -->
    <div id="choices" class="w-full max-w-3xl flex flex-col gap-3"></div>

    <!-- Dev console for quick saves (hidden) -->
    <textarea id="saveData" class="hidden"></textarea>

    <!-- Game logic module (loads AFTER marked, Tailwind) -->
    <script type="module">
      import StoryEngine, { demoStory } from './branching_story_engine.js';

      const sceneEl = document.getElementById('scene');
      const choicesEl = document.getElementById('choices');

      // Helper to render Markdown if available, else fallback
      const renderMarkdown = (md) => {
        if (window.marked && typeof window.marked.parse === 'function') {
          return window.marked.parse(md);
        }
        // naïve fallback: convert line breaks
        return md.replace(/\n/g, '<br>');
      };

      // Restore save (if any)
      const saved = localStorage.getItem('chaimAdventureSave');

      const engine = new StoryEngine({
        data: demoStory,
        onScene: ({ text, img, visibleChoices }) => {
          try {
            sceneEl.innerHTML = renderMarkdown(text);
          } catch (err) {
            console.error('Markdown render failed', err);
            sceneEl.textContent = text;
          }

          sceneEl.style.backgroundImage = img ? `url(${img})` : 'none';

          // Render choices
          choicesEl.innerHTML = '';
          if (!visibleChoices.length) {
            const endMsg = document.createElement('p');
            endMsg.textContent = 'THE END — refresh to replay';
            choicesEl.appendChild(endMsg);
            return;
          }

          visibleChoices.forEach((choice, idx) => {
            const btn = document.createElement('button');
            btn.className = 'px-4 py-2 rounded bg-purple-700 hover:bg-purple-600 active:scale-95 transition text-white';
            btn.textContent = choice.text;
            btn.onclick = () => engine.choose(idx);
            choicesEl.appendChild(btn);
          });

          // Auto‑save after rendering the scene
          localStorage.setItem('chaimAdventureSave', engine.save());
        },
      });

      // Start or resume game
      try {
        if (saved) {
          engine.load(saved);
        } else {
          engine.start();
        }
      } catch (e) {
        console.error('Load/start failed:', e);
        engine.start();
      }
    </script>
  </body>
</html>
